<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Restaurant Billing</title>
<style>
/* =========================
   Core layout & typography
   (Kept your original visual style)
   ========================= */
*{margin:0;padding:0;box-sizing:border-box;font-family:Poppins,sans-serif;}
body{display:flex;flex-direction:column;height:100vh;background:radial-gradient(circle,#0f2027,#000);color:#fff;overflow:hidden;}
header{padding:15px;background:rgba(25,25,25,0.95);color:#00aaff;font-size:22px;font-weight:bold;display:flex;justify-content:space-between;align-items:center;box-shadow:0 0 20px rgba(0,150,255,0.3);}
button.logout{background:#ff3333;padding:6px 12px;border:none;border-radius:8px;color:white;cursor:pointer;}
.container{display:flex;flex:1;height:calc(100vh - 60px);}
.sidebar{width:25%;background:rgba(34,34,34,0.9);padding:20px;overflow-y:auto;border-right:2px solid #1e90ff;}
.cart{width:45%;background:rgba(20,20,20,0.9);padding:20px;overflow-y:auto;border-left:2px solid #1e90ff;border-right:2px solid #1e90ff;}
.receipt{width:30%;background:rgba(25,25,25,0.95);padding:25px;overflow-y:auto;border-left:2px solid #1e90ff;}
h3{color:#1e90ff;margin-bottom:10px;}
.category-block{margin-bottom:14px;}
.item{background:#222;padding:8px 10px;margin-bottom:8px;border-radius:8px;cursor:pointer;user-select:none;}
.item:hover{background:#1e90ff;color:white;transform:scale(1.03);}
/* table */
table{width:100%;border-collapse:collapse;}
th,td{border-bottom:1px solid #333;padding:8px;text-align:center;}
.total{margin-top:15px;text-align:right;font-size:18px;}
.generate{width:100%;margin-top:10px;padding:10px;border:none;border-radius:8px;background:linear-gradient(90deg,#0078ff,#00aaff);color:white;font-size:16px;cursor:pointer;}
.generate:hover{box-shadow:0 0 20px #1e90ff;transform:scale(1.02);}
/* qty buttons */
.qty-btn{padding:4px 8px;margin:0 4px;border-radius:4px;background:#222;color:#fff;border:none;cursor:pointer;}
.qty-btn:disabled{opacity:0.5;cursor:not-allowed;}
.receipt-box{background:#111;border:1px solid rgba(0,150,255,0.3);border-radius:10px;padding:15px;color:#ccc;font-size:14px;line-height:1.6;height:70%;overflow-y:auto;}

/* inputs in sidebar */
.sidebar input[type="text"], .sidebar input[type="number"], .sidebar select {
  width:100%; padding:8px; border-radius:6px; border:none; margin-bottom:8px;
  background:#1a1a1a; color:#fff; outline:none;
}

/* small notes */
.small-note{font-size:12px;color:#bbb;margin-top:6px;}

/* ====== Shake animation for + buttons ====== */
@keyframes shakeX {
  0% { transform: translateX(0); }
  25% { transform: translateX(-6px); }
  50% { transform: translateX(6px); }
  75% { transform: translateX(-6px); }
  100% { transform: translateX(0); }
}
.qty-btn.shake {
  animation: shakeX 0.35s ease;
  background: #ff4444 !important;
  color: #fff !important;
  border-color: rgba(255,0,0,0.2);
}

/* subtle responsive */
@media (max-width:900px){
  .container{flex-direction:column;height:auto;}
  .sidebar,.cart,.receipt{width:100%;}
  body{height:auto;}
}
</style>
</head>
<body>
<header>
  üç¥ Restaurant Billing System
  <a href="/logout"><button class="logout">Logout</button></a>
</header>

<div class="container">

  <!-- ---------------- Sidebar (menu + add item) ---------------- -->
  <div class="sidebar">
    <!-- STARTERS block -->
    <div class="category-block" id="cat-starters">
      <h3>ü•ó Starters</h3>
      <div class="item" data-name="Paneer Tikka" data-price="180">Paneer Tikka - ‚Çπ180</div>
      <div class="item" data-name="Veg Soup" data-price="120">Veg Soup - ‚Çπ120</div>
      <div class="item" data-name="Spring Roll" data-price="100">Spring Roll - ‚Çπ100</div>
    </div>

    <!-- MAIN COURSE block -->
    <div class="category-block" id="cat-main">
      <h3>üçõ Main Course</h3>
      <div class="item" data-name="Butter Chicken" data-price="260">Butter Chicken - ‚Çπ260</div>
      <div class="item" data-name="Veg Biryani" data-price="200">Veg Biryani - ‚Çπ200</div>
      <div class="item" data-name="Paneer Butter Masala" data-price="220">Paneer Butter Masala - ‚Çπ220</div>
    </div>

    <!-- DESSERTS block -->
    <div class="category-block" id="cat-desserts">
      <h3>üç∞ Desserts</h3>
      <div class="item" data-name="Ice Cream" data-price="90">Ice Cream - ‚Çπ90</div>
      <div class="item" data-name="Gulab Jamun" data-price="70">Gulab Jamun - ‚Çπ70</div>
      <div class="item" data-name="Brownie" data-price="110">Brownie - ‚Çπ110</div>
    </div>

    <br />
    <h3>‚ûï Add New Item</h3>
    <input id="newItemName" type="text" placeholder="Item Name" aria-label="New item name">
    <input id="newItemPrice" type="number" placeholder="Price (numbers only)" aria-label="New item price">
    <select id="newItemCategory" aria-label="Category">
      <option value="starters">Starters</option>
      <option value="main">Main Course</option>
      <option value="desserts">Desserts</option>
    </select>
    <button class="generate" id="addItemBtn" type="button">Add Item</button>
    <div class="small-note">Choose category to add item into that section. New items become clickable to add to cart.</div>
  </div>

  <!-- ---------------- Cart area ---------------- -->
  <div class="cart">
    <h2>üõí Cart</h2>
    <table id="cartTable" aria-label="Cart table">
      <thead>
        <tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="total" id="totalAmount">Subtotal: ‚Çπ0<br>Tax (5%): ‚Çπ0<br><strong>Grand Total: ‚Çπ0</strong></div>
    <button class="generate" onclick="generateReceipt()" type="button">Generate Bill</button>
  </div>

  <!-- ---------------- Receipt area ---------------- -->
  <div class="receipt">
    <h3>üßæ Receipt Preview</h3>
    <div style="font-size:13px;color:#ccc;margin-bottom:10px;">
      <strong>Customer Email:</strong> {{ email|safe }}<br>
      <strong>Mobile:</strong> {{ mobile|safe }}
    </div>

    <div class="receipt-box" id="receiptBox">No items yet...</div>
    <button class="generate" onclick="printReceipt()" type="button">üñ®Ô∏è Print Receipt</button>
  </div>

</div>

<script>
/*
  Final working script:
  - categories: Starters, Main Course, Desserts
  - add new item into selected category
  - menu items (existing + added) clickable to add to cart
  - cart rows have - and + buttons
  - max per-item qty = 20
  - when trying to increase above 20: + buttons shake red and all qty buttons disabled for 1s
  - script placed at end so DOM is ready
*/

const MAX_QTY = 20;
let cart = [];          // {name, price, qty}
let alertLock = false;  // temporary lock while alert plays

/* ---------- Utility: locate category container by value ---------- */
function getCategoryContainer(value) {
  switch (value) {
    case 'starters': return document.getElementById('cat-starters');
    case 'main': return document.getElementById('cat-main');
    case 'desserts': return document.getElementById('cat-desserts');
    default: return document.getElementById('cat-starters');
  }
}

/* ---------- Initialize existing menu item clicks ---------- */
function initMenuClicks() {
  // attach to all .item inside sidebar
  const items = document.querySelectorAll('.sidebar .item');
  items.forEach(el => {
    // ensure no duplicate listeners
    el.removeEventListener('click', itemClickHandler);
    el.addEventListener('click', itemClickHandler);
  });
}

function itemClickHandler(e) {
  // get name & price from data attributes (preferred) or from text
  const el = e.currentTarget;
  const name = el.getAttribute('data-name') || el.textContent.split(' - ')[0].trim();
  const price = parseFloat(el.getAttribute('data-price') || ('' + el.textContent).replace(/.*‚Çπ/,'').trim());
  addToCart(name, price);
}

/* ---------- Add new menu item into chosen category ---------- */
function addNewMenuItem() {
  const nameInput = document.getElementById('newItemName');
  const priceInput = document.getElementById('newItemPrice');
  const catSelect = document.getElementById('newItemCategory');

  const name = nameInput.value.trim();
  const price = parseFloat(priceInput.value);
  const category = catSelect.value;

  if(!name || Number.isNaN(price) || price < 0) {
    alert('Enter valid item name and non-negative price.');
    return;
  }

  // create element (same markup & class as original)
  const div = document.createElement('div');
  div.className = 'item';
  div.setAttribute('data-name', name);
  div.setAttribute('data-price', String(price));
  div.textContent = `${name} - ‚Çπ${price}`;

  // bind click to add to cart
  div.addEventListener('click', itemClickHandler);

  // append to correct category container
  const container = getCategoryContainer(category);
  // insert before the "Add New Item" form area; append is fine because blocks are grouped
  container.appendChild(div);

  // clear inputs
  nameInput.value = '';
  priceInput.value = '';

  // re-init menu clicks (not strictly necessary since we bound directly)
  initMenuClicks();
}

/* ---------- Add item to cart ---------- */
function addToCart(name, price) {
  if (alertLock) return;

  const existing = cart.find(it => it.name === name);
  if (existing) {
    if (existing.qty >= MAX_QTY) {
      triggerMaxLimitAlert();
      return;
    }
    existing.qty += 1;
  } else {
    cart.push({ name, price, qty: 1 });
  }
  updateCartUI();
}

/* ---------- Change quantity at index ---------- */
function changeQtyAtIndex(index, delta) {
  if (alertLock) return;
  if (index < 0 || index >= cart.length) return;

  const item = cart[index];

  if (delta === 1 && item.qty >= MAX_QTY) {
    triggerMaxLimitAlert(index);
    return;
  }

  item.qty += delta;
  if (item.qty <= 0) {
    cart.splice(index, 1);
  }
  updateCartUI();
}

/* ---------- Trigger max-limit alert:
   shake only plus buttons, disable all qty buttons temporarily ---------- */
function triggerMaxLimitAlert() {
  const plusButtons = Array.from(document.querySelectorAll('.qty-btn[data-dir="plus"]'));
  const allButtons = Array.from(document.querySelectorAll('.qty-btn'));

  plusButtons.forEach(btn => btn.classList.add('shake'));
  allButtons.forEach(btn => btn.disabled = true);

  alertLock = true;

  setTimeout(() => {
    plusButtons.forEach(btn => btn.classList.remove('shake'));
    allButtons.forEach(btn => btn.disabled = false);
    alertLock = false;
    // ensure plus buttons that should be disabled (at max) remain disabled
    enforcePlusDisabledState();
  }, 900);
}

/* ---------- Ensure plus buttons disabled for items at MAX_QTY ---------- */
function enforcePlusDisabledState() {
  // walk through cart table rows and set plus disabled where needed
  const plusButtons = document.querySelectorAll('.qty-btn[data-dir="plus"]');
  plusButtons.forEach((btn, idx) => {
    const item = cart[idx];
    if (!item) {
      btn.disabled = false;
    } else {
      btn.disabled = item.qty >= MAX_QTY;
    }
  });
}

/* ---------- Update cart UI (table + totals) ---------- */
function updateCartUI() {
  const tbody = document.querySelector('#cartTable tbody');
  tbody.innerHTML = '';

  let subtotal = 0;

  cart.forEach((item, idx) => {
    const row = document.createElement('tr');

    // name cell
    const nameCell = document.createElement('td');
    nameCell.textContent = item.name;
    row.appendChild(nameCell);

    // qty cell with - and + buttons
    const qtyCell = document.createElement('td');

    const minusBtn = document.createElement('button');
    minusBtn.className = 'qty-btn';
    minusBtn.type = 'button';
    minusBtn.setAttribute('data-dir', 'minus');
    minusBtn.textContent = '-';
    minusBtn.addEventListener('click', () => changeQtyAtIndex(idx, -1));

    const qtyText = document.createTextNode(` ${item.qty} `);

    const plusBtn = document.createElement('button');
    plusBtn.className = 'qty-btn';
    plusBtn.type = 'button';
    plusBtn.setAttribute('data-dir', 'plus');
    plusBtn.textContent = '+';
    plusBtn.addEventListener('click', () => changeQtyAtIndex(idx, 1));

    // disable plus if at max
    plusBtn.disabled = item.qty >= MAX_QTY;

    qtyCell.appendChild(minusBtn);
    qtyCell.appendChild(qtyText);
    qtyCell.appendChild(plusBtn);

    row.appendChild(qtyCell);

    // price cell
    const priceCell = document.createElement('td');
    priceCell.textContent = `‚Çπ${item.price}`;
    row.appendChild(priceCell);

    // total cell
    const totalCell = document.createElement('td');
    const total = item.price * item.qty;
    totalCell.textContent = `‚Çπ${total}`;
    row.appendChild(totalCell);

    tbody.appendChild(row);

    subtotal += total;
  });

  const tax = subtotal * 0.05;
  const grandTotal = subtotal + tax;
  document.getElementById('totalAmount').innerHTML =
    `Subtotal: ‚Çπ${subtotal.toFixed(2)}<br>Tax (5%): ‚Çπ${tax.toFixed(2)}<br><strong>Grand Total: ‚Çπ${grandTotal.toFixed(2)}</strong>`;

  // ensure plus buttons state is enforced
  enforcePlusDisabledState();
}

/* ---------- Generate receipt ---------- */
function generateReceipt() {
  if (cart.length === 0) {
    document.getElementById('receiptBox').innerHTML = 'No items in cart.';
    return;
  }

  let subtotal = 0;
  let html = "<div style='text-align:center;font-weight:bold;color:#00aaff;'>RESTAURANT BILL</div><hr>";

  cart.forEach(item => {
    const sub = item.price * item.qty;
    subtotal += sub;
    html += `<div style='display:flex;justify-content:space-between;margin:6px 0;'><span>${item.name} x ${item.qty}</span><span>‚Çπ${sub}</span></div>`;
  });

  const tax = subtotal * 0.05;
  const total = subtotal + tax;

  html += `<hr>
    <div style='display:flex;justify-content:space-between;'><span>Subtotal</span><span>‚Çπ${subtotal.toFixed(2)}</span></div>
    <div style='display:flex;justify-content:space-between;'><span>Tax (5%)</span><span>‚Çπ${tax.toFixed(2)}</span></div>
    <div style='display:flex;justify-content:space-between;font-weight:bold;color:#00aaff;margin-top:8px;'><span>Total</span><span>‚Çπ${total.toFixed(2)}</span></div>
    <div style='text-align:center;color:#999;margin-top:12px;'>‚ú® Thank you! Visit again ‚ú®</div>`;

  document.getElementById('receiptBox').innerHTML = html;
}

/* ---------- Print receipt ---------- */
function printReceipt() {
  const printContent = document.getElementById('receiptBox').innerHTML;
  const staffInfo = `<h3>Restaurant Billing System</h3>
        <p><strong>Email:</strong> {{ email|safe }}<br><strong>Mobile:</strong> {{ mobile|safe }}</p><hr>`;

  const newWin = window.open('', '_blank');
  newWin.document.write("<html><head><title>Receipt</title></head><body>" + staffInfo + printContent + "</body></html>");
  newWin.document.close();
  setTimeout(() => { newWin.print(); newWin.close(); }, 300);
}

/* ---------- Initialization ---------- */
function initApp() {
  // Bind existing menu items
  initMenuClicks();

  // Bind add item button
  const addBtn = document.getElementById('addItemBtn');
  addBtn.addEventListener('click', addNewMenuItem);

  // initial cart UI
  updateCartUI();
}

// start
initApp();
</script>
</body>
</html>
